#include <iostream>
#include <cctype>
#include <string>
#include <vector>
#include <stdexcept>
#include <cmath>
#include <sstream>
#include <algorithm>

struct Instruction
{
    std::string operation;
    std::string operand1;
    std::string operand2;
    std::string result;
};

class SimpleParser
{
private:
    int tempVarCount;
    std::vector<Instruction> instructions;

    std::string getTempVar()
    {
        return "temp" + std::to_string(tempVarCount++);
    }

    void addInstruction(const std::string &operation, const std::string &operand1,
                        const std::string &operand2, const std::string &result)
    {
        instructions.push_back({operation, operand1, operand2, result});
    }

public:
    SimpleParser() : tempVarCount(0) {}

    void parseAndGenerateArithmeticInstructions(double a, double b)
    {
        std::string temp1 = getTempVar();
        addInstruction("ADD", std::to_string(a), std::to_string(b), temp1);

        std::string temp2 = getTempVar();
        addInstruction("SUB", std::to_string(a), std::to_string(b), temp2);

        std::string temp3 = getTempVar();
        addInstruction("MUL", std::to_string(a), std::to_string(b), temp3);

        std::string temp4 = getTempVar();
        addInstruction("DIV", std::to_string(a), std::to_string(b), temp4);
    }

    void parseAndGeneratePolynomialInstructions(const std::string &polyInput, double x, double y)
    {
        std::string xStr = "x", yStr = "y";
        std::string polynomial = polyInput;

        // Normalize '-' into '+-' for splitting
        for (size_t i = 1; i < polynomial.size(); ++i)
        {
            if (polynomial[i] == '-' && polynomial[i - 1] != '+' && polynomial[i - 1] != '-')
            {
                polynomial.insert(i, "+");
                ++i;
            }
        }

        std::istringstream iss(polynomial);
        std::string term;
        std::vector<std::string> tempResults;

        while (std::getline(iss, term, '+'))
        {
            term.erase(remove_if(term.begin(), term.end(), ::isspace), term.end());
            if (term.empty()) continue;

            std::string temp;

            if (term.find("x^2") != std::string::npos)
            {
                std::string coeff = term.substr(0, term.find("x^2"));
                if (coeff.empty()) coeff = "1";
                else if (coeff == "-") coeff = "-1";

                std::string t1 = getTempVar();
                addInstruction("MUL", xStr, xStr, t1);

                temp = getTempVar();
                addInstruction("MUL", coeff, t1, temp);
            }
            else if (term.find("y^2") != std::string::npos)
            {
                std::string coeff = term.substr(0, term.find("y^2"));
                if (coeff.empty()) coeff = "1";
                else if (coeff == "-") coeff = "-1";

                std::string t1 = getTempVar();
                addInstruction("MUL", yStr, yStr, t1);

                temp = getTempVar();
                addInstruction("MUL", coeff, t1, temp);
            }
            else if (term.find("x") != std::string::npos)
            {
                std::string coeff = term.substr(0, term.find("x"));
                if (coeff.empty()) coeff = "1";
                else if (coeff == "-") coeff = "-1";

                temp = getTempVar();
                addInstruction("MUL", coeff, xStr, temp);
            }
            else if (term.find("y") != std::string::npos)
            {
                std::string coeff = term.substr(0, term.find("y"));
                if (coeff.empty()) coeff = "1";
                else if (coeff == "-") coeff = "-1";

                temp = getTempVar();
                addInstruction("MUL", coeff, yStr, temp);
            }
            else
            {
                temp = getTempVar();
                addInstruction("ADD", term, "0", temp);
            }

            tempResults.push_back(temp);
        }

        // Sum all results
        std::string result = tempResults[0];
        for (size_t i = 1; i < tempResults.size(); ++i)
        {
            std::string newTemp = getTempVar();
            addInstruction("ADD", result, tempResults[i], newTemp);
            result = newTemp;
        }

        addInstruction("EQUALS", result, "0", "result");
    }

    void printInstructions() const
    {
        std::cout << "Generated Instructions:\n";
        for (const auto &instr : instructions)
        {
            std::cout << instr.operation << " " << instr.operand1;
            if (!instr.operand2.empty())
            {
                std::cout << " " << instr.operand2;
            }
            std::cout << " -> " << instr.result << "\n";
        }
    }
};

int main()
{
    try
    {
        int choice;
        std::cout << "Enter 1 for arithmetic manipulations or 2 for polynomial manipulations: ";
        std::cin >> choice;

        if (choice == 1)
        {
            double a, b;
            std::cout << "Enter two numbers (a and b): ";
            std::cin >> a >> b;

            SimpleParser parser;
            parser.parseAndGenerateArithmeticInstructions(a, b);
            parser.printInstructions();
        }
        else if (choice == 2)
        {
            double x, y;
            std::string polynomial;

            std::cin.ignore(); // Clear input buffer
            std::cout << "Enter the polynomial (e.g., 3x^2+2y^2-12x-12y+30): ";
            std::getline(std::cin, polynomial);

            std::cout << "Enter value for x: ";
            std::cin >> x;
            std::cout << "Enter value for y: ";
            std::cin >> y;

            SimpleParser parser;
            parser.parseAndGeneratePolynomialInstructions(polynomial, x, y);
            parser.printInstructions();
        }
        else
        {
            std::cerr << "Invalid choice. Please enter 1 or 2.\n";
        }
    }
    catch (const std::exception &e)
    {
        std::cerr << e.what() << '\n';
    }

    return 0;
}
